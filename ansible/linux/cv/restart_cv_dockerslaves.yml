---
- hosts: all
  gather_facts: False

  vars:
    ansible_user: couchbase
    ansible_pass: couchbase
    restart_cmd: >-
          /home/couchbase/build/docker/scripts/restart_jenkinsdocker.py
          {{ docker_image }}
          {{ slave_name }}
          2222
          cv.jenkins.couchbase.com
          --ccache-dir /home/couchbase/shared_ccache

  tasks:
    - name: Update build repo
      git:
        repo: git://github.com/couchbase/build
        dest: /home/couchbase/build

    - name: Create shared CCache directory
      file:
        name: "{{ item }}"
        state: directory
      with_items:
        - /home/couchbase/shared_ccache

    - name: Copy CCache configuration
      copy:
        src: ccache.conf
        dest: /home/couchbase/shared_ccache/ccache.conf
        mode: 0644

    - name: Remove old jenkinsdocker-ssh
      file:
        name: /home/couchbase/jenkinsdocker-ssh
        state: absent

    - name: Copy new jenkinsdocker-ssh
      copy:
        src: /home/couchbase/jenkinsdocker-ssh
        dest: /home/couchbase

    - name: Ensure cronscript exists
      file:
        path: /home/couchbase/cronscript
        state: touch

    - include_tasks: add_docker_slave.yml
      vars:
        restart_cmd: >-
          /home/couchbase/build/docker/scripts/restart_jenkinsdocker.py
          {{ item.docker_image }}
          {{ item.slave_name }}
          {{ item.port | default('2222') }}
          cv.jenkins.couchbase.com
          --ccache-dir /home/couchbase/shared_ccache
      loop: "{{ slaves }}"

    - name: "{{ item.slave_name }} - Remove unused docker images and data"
      shell: "docker system prune --all --force"

    - name: Add disk-check cron job
      cron:
        name: "check diskspace"
        minute: "0"
        job: "/bin/bash /home/couchbase/cronscript"

    - name: Add public SSH keys for easy access
      copy:
        src: authorized_keys
        dest: /home/couchbase/.ssh
        mode: 0600
